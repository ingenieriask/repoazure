{% extends 'correspondence/main_template.html' %}

{% load static %}
{% load custom_tags %}

{% block content %}

<style type="text/css" scoped>

.inicio {
    background-color: #e9c46a !important;
    border-radius: 50% !important;
    min-width: 80px !important;
    width: 80px !important;
}

.fin {
    background-color: #e9c46a !important;
    border-radius: 50% !important;
    min-width: 80px !important;
    width: 80px !important;
}
.avalador {
    background-color: rgba(177, 191, 250, 0.8) !important;
    min-width: 135px !important;
    width: 135px !important;
}

.firmante {
    background-color: #95d5b2 !important;
    border: 2px solid #658542 !important;
    min-width: 135px !important;
    width: 135px !important;
}

.selected {
    border-color: #e3c000 !important;
}

.node {
  border-radius: 30%;
  cursor: pointer;
  height: auto;
  padding-bottom: 6px;
  box-sizing: content-box;
  position: relative;
  user-select: none;
}

.selectpicker {
    width: 100px !important;
}

.rete {
    height: 400px;
    /*overflow-x: scroll;*/
    padding: 10px;
    border: 1px solid #bbbbbb;
    border-radius: 5px;
}

.userinput {
    width: 100px !important;
}

#id-graph-alert {
    color: red;
}

</style>

<div class="card mb-4">
    <div class="card-body">
        <form method="post" enctype="multipart/form-data" action="{% url 'workflow:signature' radicate=radicate %}" autocomplete="off">

            {% load crispy_forms_tags %}
            {{ form | crispy }}
            {% csrf_token %}

            <input id="id-graph" name="graph" type="hidden" value="">

            <div class="rete">

                {% if messages %}
                    {% for message in messages %}
                        <div id="id-graph-alert">{{ message|safe }}</div>
                    {% endfor %}
                {% endif %}

                <div id="rete"></div>
            </div>

            <input type="submit" name="button" class="btn btn-success mt-3" value="Guardar">
        </form>
    </div>
</div>

<div class="modal fade" id="userModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-m" role="document">
        <div class="modal-content">
            <div class="modal-header">
                BÃºsqueda de Usuario
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row justify-content-center">
                <div class="col-12" id="file-display-field">
                    {% select_user %}
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'node_modules/jquery/dist/jquery.min.js' %}"></script>
<script src="{% static 'node_modules/vue/dist/vue.min.js' %}"></script>
<script src="{% static 'node_modules/rete/build/rete.min.js' %}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.20/lodash.min.js"></script>
<script src="{% static 'node_modules/rete-connection-plugin/build/connection-plugin.min.js' %}"></script>
<script src="{% static 'node_modules/rete-context-menu-plugin/build/context-menu-plugin.common.js' %}"></script>
<script src="{% static 'node_modules/rete-context-menu-plugin/build/context-menu-plugin.min.js' %}"></script>
<script src="{% static 'node_modules/rete-vue-render-plugin/build/vue-render-plugin.min.js' %}"></script>
<script src="{% static 'node_modules/rete-comment-plugin/build/comment-plugin.min.js' %}"></script>
<script src="{% static 'node_modules/rete-keyboard-plugin/build/keyboard-plugin.min.js' %}"></script>
<script src="{% static 'node_modules/rete-area-plugin/build/area-plugin.min.js' %}"></script>

{{ widget.graph|json_script:"graph" }}

<script>

var graph = JSON.parse(document.getElementById('graph').textContent);

var actSocket = new Rete.Socket("Action");

var mounted = false;

function getVueUserControl(key, userType) {
    return {
        props: ['emitter', 'ikey', 'getData', 'putData'],
        template: `<input id="${key}_selected" class="userinput" readonly=true v-on:click="showModal($event)" \
                value="test" data-toggle="tooltip" data-placement="top" title="Tooltip test" />`
        ,
        data() {
            return {
                value: 0
            }
        },
        methods: {
            showModal(e){
                console.info('evet:', e)
                $('#user_selected').find('option').remove().end();
                $("#user_selected").append('<option value=-1>Ninguno seleccionado</option>')
                response.forEach(function (value) {
                    $("#user_selected").append(
                        `<option value=${value.pk}>${value.username} ${value.first_name} ${value.last_name}'</option>`)
                });
                $("#user_selected").selectpicker('refresh');
                $('#userModal').modal()
            },
            change(e){
                this.value = e.target.value;
                this.update();
            },
            update() {
            if (this.ikey)
                this.putData(this.ikey, this.value)
            this.emitter.trigger('process');
            }
        },
        mounted() {
            this.value = this.getData(this.ikey);
        }
    }
}

class UserControl extends Rete.Control {
    constructor(emitter, key, userType, user_id) {
        super(key);
        this.component = getVueUserControl(key, userType, user_id);
        this.props = {emitter, ikey: 'user_id'};
    }
}

class InputComponent extends Rete.Component {
    constructor(){
        super("Inicio");
    }
    builder(node) {
        var out = new Rete.Output('out', "Inicio", actSocket, true);
        return node.addOutput(out);
    }
    worker(node, inputs, outputs) {
    }
}

class OutputComponent extends Rete.Component {
    constructor(){
        super("Fin");
    }
    builder(node) {
        var inp = new Rete.Input('in', "Fin", actSocket, true);
        return node.addInput(inp);
    }
    worker(node, inputs, outputs) {
    }
}

class GuarantorUserComponent extends Rete.Component {
    constructor(){
        super("Avalador");
    }
    builder(node) {
        var ctrl = new UserControl(this.editor, node.id, 'guarantoruser', node.data.user_id);
        var inp = new Rete.Input('in',"Inicio", actSocket, true);
        var out = new Rete.Output('out', "Fin", actSocket, true);
        return node
            .addInput(inp)
            .addControl(ctrl)
            .addOutput(out);
    }
    worker(node, inputs, outputs) {
    }
}

class SigningUserComponent extends Rete.Component {
    constructor(){
        super("Firmante");
    }
    builder(node) {
        var ctrl = new UserControl(this.editor, node.id, 'signinguser', node.data.user_id);
        var inp = new Rete.Input('in',"Inicio", actSocket, true);
        var out = new Rete.Output('out', "Fin", actSocket, true);
        return node
            .addInput(inp)
            .addControl(ctrl)
            .addOutput(out);
    }

    worker(node, inputs, outputs) {
        var value = inputs['in'].length ? inputs['in'][0] : node.data.value;
        outputs['value'] = value;
    }
}

var container = document.querySelector('#rete');
var components = [new InputComponent(), new OutputComponent(), new GuarantorUserComponent(), new SigningUserComponent()];

var editor = new Rete.NodeEditor('demo@0.1.0', container);
editor.use(ConnectionPlugin.default);
editor.use(VueRenderPlugin.default);   
editor.use(ContextMenuPlugin.default, {
    searchBar: false,
});
editor.use(AreaPlugin);
editor.use(CommentPlugin.default);
editor.use(KeyboardPlugin);

var engine = new Rete.Engine('demo@0.1.0');


components.map(c => {
    editor.register(c);
    engine.register(c);
});

editor.on('connectioncreate connectionremove nodecreate noderemove process', ()=>{
    compile();
    if (mounted) {
        $('#id-graph-alert').html('');
    }
});

async function compile() {
    await engine.abort();
    await engine.process(editor.toJSON());
    $('#id-graph').val(JSON.stringify(editor.toJSON()));
}

editor.fromJSON(graph).then(() => {
    editor.view.resize();
    compile();
    mounted = true;    
});

editor.on('zoom', (e) => {
  let k = e.transform.k; 
  if (e.zoom > k) { 
    e.zoom = k + 0.02;
  } else if (e.zoom < k) {
    e.zoom = k - 0.02;
  }
  e.zoom = +e.zoom.toFixed(2);
  return e.source !== 'dblclick'; 
});

</script>

{% endblock %}

