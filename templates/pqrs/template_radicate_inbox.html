{% extends 'correspondence/main_template.html' %}

{% load static %}
{% block content %}
{% load pqrs_extras %}

<script src="{% static 'node_modules/jquery/dist/jquery.min.js' %}"></script>

  <div class="card mb-4">
      <div class="card-body">
        <div class="text-right m-2">
        </div>
        <div class="datatable">

          <div id="radicateList_wrapper" class="dataTables_wrapper dt-bootstrap4 no-footer">

            <form id="query" method="get">
              <div class="row">
                <div id="keyword" class="mr-auto">
                  <div id="radicateList_filter" class="dataTables_filter">
                    <label>
                      <input id="radicateList_search" type="search" class="form-control form-control-sm" 
                      placeholder="Escriba una palabra clave para realizar la búsqueda..." 
                      name="filter" aria-controls="radicateList" value={{ filter }}>
                    </label>
                    <input class="btn btn-outline-primary btn-sm" type="submit" value="Enviar" />
                  </div>
                </div>
                <div class="col-3">
                  <div class="dataTables_length">
                    <label>Mostrar 
                      <select id="radicateList_length" 
                        name="paginate_by" 
                        aria-controls="radicateList" 
                        class="custom-select custom-select-sm form-control form-control-sm">
                        {% for i in 30|page_range %}
                        <option value="{{ i }}" {% if paginator.per_page  == i %} selected {% endif %} >{{ i }}</option>
                        {% endfor %}
                      </select> 
                      registros
                    </label>
                  </div>
                </div>
              </div>
            </form>

            <div class="row">
              <table class="table table-bordered table-hover" id="radicateList" width="100%" cellspacing='0'>
                <thead>
                  <tr>
                    <th style="text-align: center;">Número de radicado</th>
                    <th style="text-align: center;" class="d-none d-md-table-cell">Fecha de radicación</th>
                    <th style="text-align: center;">Asunto</th>
                    <th style="text-align: center;" class="d-none d-md-table-cell">Solicitante</th>
                    <th style="text-align: center;" class="d-none d-md-table-cell">Tipo y Tema PQRSD</th>
                    <th style="text-align: center;" class="d-none d-md-table-cell">Días hábiles para dar respuesta</th>
                    <th style="text-align: center;" class="d-none d-md-table-cell">Estado</th>
                    <th style="text-align: center;">Detalles</th>
                  </tr>
                </thead>
                
                <tbody>
                  {% for pqrs in pqrs %}
                  <tr>
                    <td style="text-align: center;">
                      <a class="display-modal"
                        data-pk="{{ pqrs.pk }}"
                        data-toggle="modal" data-target="#fileModal"
                      >{{ pqrs.number }}</a>
                    </td>
                    <td style="text-align: center;" class="d-none d-md-table-cell">{{ pqrs.date_radicated }}</td>
                    <td style="text-align: center;">{{ pqrs.subject }}</td>
                    {% if pqrs.person.is_anonymous == True %}
                        <td style="text-align: center;" class="d-none d-md-table-cell">ANÓNIMO</td>
                    {% elif pqrs.person %}
                        <td style="text-align: center;" class="d-none d-md-table-cell">{{ pqrs.person.name }}</td>
                    {% else %}
                        <td style="text-align: center;" class="d-none d-md-table-cell">{{ pqrs.email_user_name }}</td>
                    {% endif %}
                    <td style="text-align: center;" class="d-none d-md-table-cell">{{ pqrs.subtype.type.name }} - {{ pqrs.subtype.name }}</td>
                    <td style="text-align: center;" class="d-none d-md-table-cell">
                        <svg height="8mm" width="8mm">
                          <circle cx="4mm" cy="4mm" r="3mm" style="fill: {{ pqrs.subtype.alerts.all|get_color_traffic_light:pqrs.date_radicated }};" />
                        </svg>
                        {{ pqrs.date_radicated|get_missing_days:pqrs.subtype.max_response_days }}    
                    </td>
                    <td style="text-align: center;" class="d-none d-md-table-cell">{{ pqrs.pqrsobject.get_status_str }}</td>
                    <td style="text-align: center;">

                      {% block actions %}
                      {% endblock %}
                  </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="row">
              <div class="col-sm-12 col-md-5">
              </div><div class="col-sm-12 col-md-7">
                <div class="dataTables_paginate paging_simple_numbers" id="radicateList_paginate">
                  <ul class="pagination">
                    <li class="paginate_button page-item previous {% if not page_obj.has_previous %} disabled {% endif %}" 
                      id="radicateList_previous">
                      <a {% if page_obj.has_previous %} href="?page={{ page_obj.previous_page_number }}&filter={{ filter }}&paginate_by={{ paginator.per_page }}" {% endif %} aria-controls="radicateList" data-dt-idx="0" tabindex="0" class="page-link">Anterior</a>
                    </li>
                    {% for i in paginator.page_range %}
                    <li class="paginate_button page-item {% if page_obj.number == i %} active {% endif %}">
                      <a href="?page={{i}}&filter={{ filter }}&paginate_by={{ paginator.per_page }}" aria-controls="radicateList" data-dt-idx="{{ i }}" tabindex="0" class="page-link">{{ i }}</a>
                    </li>
                    {% endfor %}
                    <li class="paginate_button page-item next {% if not page_obj.has_next %}disabled{% endif %}" 
                    id="radicateList_next">
                      <a {% if page_obj.has_next %} href="?page={{ page_obj.next_page_number }}&filter={{ filter }}&paginate_by={{ paginator.per_page }}" {% endif %} aria-controls="radicateList" data-dt-idx="2" tabindex="0" class="page-link">Siguiente</a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="fileModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-xl" role="document">
      <div class="modal-content">
      <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="row justify-content-center">
            <div class="col-12" id="file-display-field">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
  console.info('test')
  $("#radicateList_length").change(function() {
    console.info( "Handler for .change() called." );
    $("#query").submit();
  });

  $("#radicateList_search").on('keyup', function (e) {
    if (e.key === 'Enter' || e.keyCode === 13) {
        console.info("test test")
    }
  });

  </script>

{% endblock %}


{% block script %} 

  $(document).ready(function() {
        $('#radicateList').DataTable( {
            "language": {
                "url": "{% static 'pqrs/js/dataTableSpanish.json' %}",
            },
            "lengthMenu": [ 3, 6, 9, 12],
            "dom": "b<'row'<'#keyword.mr-auto'f><'col-4'l>>" +
                    "<'row'<'col-sm-12'tr>>" +
                    "<'row'<'col-sm-12 col-md-7'i><'col-sm-12 col-md-5'p>>",
        });
    });     

   $('.display-modal').click(function(event){
      element = event.target;
      $('#file-display-field').empty()
        embeded_file = $('<embed class="w-100"/>'); 
      embeded_file.attr("height", "500");
      embeded_file.attr("src", '{% url "correspondence:get_file" %}?pk='+$(element).data('pk'));
      $('#file-display-field').append(embeded_file);
   })

{% endblock %}